# --- Portfolio Section (Intraday Special) ---
st.markdown("---")
st.header("ЁЯУЛ роЙроЩрпНроХро│рпН роЗройрпНроЯрпНро░ро╛роЯрпЗ роиро┐ро▓ро╡ро░роорпН (Live Positions)")

# роТро░рпБ 'Refresh' рокроЯрпНроЯройрпН - ро╡ро┐ро▓рпИропрпИ роЕрокрпНроЯрпЗроЯрпН роЪрпЖропрпНроп
if st.button("ЁЯФД ро╡ро┐ро▓рпИропрпИрокрпН рокрпБродрпБрокрпНрокро┐ (Refresh Price)"):
    st.rerun()

if st.session_state.portfolio:
    portfolio_data = []
    total_invested = 0
    current_portfolio_value = 0
    
    for s, q in st.session_state.portfolio.items():
        # роТро╡рпНро╡рпКро░рпБ рокроЩрпНроХро┐ройрпН родро▒рпНрокрпЛродрпИроп ро╡ро┐ро▓рпИропрпИ роОроЯрпБроХрпНроХро┐ро▒рпЛроорпН
        try:
            live_data = yf.Ticker(s).history(period="1d")
            if not live_data.empty:
                ltp = live_data['Close'].iloc[-1]
                
                # роиро╛роорпН ро╡ро╛роЩрпНроХро┐роп роЪро░ро╛роЪро░ро┐ ро╡ро┐ро▓рпИ (Average Buy Price) роироороХрпНроХрпБродрпН родрпЖро░ро┐ропро╛родрпБ 
                # (роОро│ро┐роорпИроХрпНроХро╛роХ роХроЯрпИроЪро┐ ро╡ро┐ро▓рпИропрпИропрпЗ ро╡ро╛роЩрпНроХро┐роп ро╡ро┐ро▓рпИропро╛роХродрпН родро▒рпНроЪрооропроорпН ро╡рпИродрпНродрпБро│рпНро│рпЛроорпН. 
                # роиро┐роЬ роЖрокрпНрокро┐ро▓рпН 'Buy Price' родройро┐ропро╛роХ роЪрпЗрооро┐роХрпНроХ ро╡рпЗрогрпНроЯрпБроорпН).
                # роЖройро╛ро▓рпН роЗрокрпНрокрпЛродрпИроХрпНроХрпБ роорпКродрпНрод роородро┐рокрпНрокрпИ роороЯрпНроЯрпБроорпН рокро╛ро░рпНрокрпНрокрпЛроорпН.
                
                val = ltp * q
                portfolio_data.append({
                    "Symbol": s, 
                    "Qty": q, 
                    "Current Price": round(ltp, 2), 
                    "Current Value": round(val, 2)
                })
                current_portfolio_value += val
        except:
            pass
        
    # роЕроЯрпНроЯро╡рогрпИропро╛роХроХрпН роХро╛роЯрпНроЯрпБродро▓рпН
    df_port = pd.DataFrame(portfolio_data)
    st.dataframe(df_port, use_container_width=True)
    
    # роорпКродрпНрод роХрогроХрпНроХрпБ (Total P&L)
    # роЗройрпНроЯрпНро░ро╛роЯрпЗро╡ро┐ро▓рпН ро▓ро╛рокрооро╛ роиро╖рпНроЯрооро╛ роОройрпНро▒рпБ рокро╛ро░рпНроХрпНроХ
    # роЖро░роорпНрок рокрогроорпН 10 ро▓роЯрпНроЪроорпН. роЗрокрпНрокрпЛродрпИроп роЪрпКродрпНродрпБ роородро┐рокрпНрокрпБ роОро╡рпНро╡ро│ро╡рпБ?
    net_worth = st.session_state.balance + current_portfolio_value
    pnl = net_worth - 1000000
    
    col1, col2, col3 = st.columns(3)
    col1.metric("роХрпИропро┐ро░рпБрокрпНрокрпБ рокрогроорпН (Cash)", f"тВ╣{st.session_state.balance:,.2f}")
    col2.metric("рокроЩрпНроХрпБроХро│ро┐ройрпН роородро┐рокрпНрокрпБ (Holdings)", f"тВ╣{current_portfolio_value:,.2f}")
    
    # ро▓ро╛рокроорпН роОройрпНро▒ро╛ро▓рпН рокроЪрпНроЪрпИ, роиро╖рпНроЯроорпН роОройрпНро▒ро╛ро▓рпН роЪро┐ро╡рокрпНрокрпБ
    col3.metric("роорпКродрпНрод ро▓ро╛рокроорпН/роиро╖рпНроЯроорпН (P&L)", f"тВ╣{pnl:,.2f}", delta=f"{pnl:,.2f}")

    # --- Square Off All (роЕройрпИродрпНродрпИропрпБроорпН ро╡ро┐ро▒рпНро▒рпБ ро╡рпЖро│ро┐ропрпЗро▒рпБ) ---
    st.markdown("### тЪб роЕро╡роЪро░ ро╡рпЖро│ро┐ропрпЗро▒рпНро▒роорпН (Panic Button)")
    if st.button("ЁЯФ┤ Square Off All (роЕройрпИродрпНродрпИропрпБроорпН ро╡ро┐ро▒рпНро▒рпБро╡ро┐роЯрпБ)"):
        # роОро▓рпНро▓ро╛ рокроЩрпНроХрпБроХро│рпИропрпБроорпН ро╡ро┐ро▒рпНро▒рпБ рокрогрооро╛роХ рооро╛ро▒рпНро▒рпБродро▓рпН
        st.session_state.balance += current_portfolio_value
        st.session_state.portfolio = {} # рокрпЛро░рпНроЯрпНроГрокрпЛро▓ро┐ропрпЛ роХро╛ро▓ро┐
        st.session_state.history.append(f"SQUARED OFF ALL POSITIONS at P&L: тВ╣{pnl:.2f}")
        st.success("роЕройрпИродрпНродрпБ рокроЩрпНроХрпБроХро│рпБроорпН ро╡ро┐ро▒рпНроХрокрпНрокроЯрпНроЯрой!")
        st.rerun()

else:
    st.info("родро▒рпНрокрпЛродрпБ роОроирпНродрокрпН рокроЩрпНроХрпБроорпН ро╡ро╛роЩрпНроХро╡ро┐ро▓рпНро▓рпИ (No Open Positions).")
